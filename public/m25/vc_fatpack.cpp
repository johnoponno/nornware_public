#include "stdafx.h"
#include "vc_fatpack.h"

#include "../micron.h"
#include "c_math.h"
#include "vc_assets.h"

namespace m25
{
	static const uint8_t ATASCII_BITS[256 * 8] =
	{
		0xff,0x93,0x01,0x01,0x83,0xc7,0xef,0xff,
		0xe7,0xe7,0xe7,0x07,0x07,0xe7,0xe7,0xe7,
		0x3f,0x3f,0x3f,0x3f,0x3f,0x3f,0x3f,0x3f,
		0xe7,0xe7,0xe7,0xe0,0xe0,0xff,0xff,0xff,
		0xe7,0xe7,0xe7,0xe0,0xe0,0xe7,0xe7,0xe7,
		0xff,0xff,0xff,0xe0,0xe0,0xe7,0xe7,0xe7,
		0x3f,0x1f,0x8f,0xc7,0xe3,0xf1,0xf8,0xfc,
		0xfc,0xf8,0xf1,0xe3,0xc7,0x8f,0x1f,0x3f,
		0x7f,0x3f,0x1f,0x0f,0x07,0x03,0x01,0x00,
		0xff,0xff,0xff,0xff,0x0f,0x0f,0x0f,0x0f,
		0xfe,0xfc,0xf8,0xf0,0xe0,0xc0,0x80,0x00,
		0x0f,0x0f,0x0f,0x0f,0xff,0xff,0xff,0xff,
		0xf0,0xf0,0xf0,0xf0,0xff,0xff,0xff,0xff,
		0x00,0x00,0xff,0xff,0xff,0xff,0xff,0xff,
		0xff,0xff,0xff,0xff,0xff,0xff,0x00,0x00,
		0xff,0xff,0xff,0xff,0xf0,0xf0,0xf0,0xf0,
		0xff,0xc7,0xc7,0x11,0x11,0xef,0xc7,0xff,
		0xff,0xff,0xff,0x07,0x07,0xe7,0xe7,0xe7,
		0xff,0xff,0xff,0x00,0x00,0xff,0xff,0xff,
		0xe7,0xe7,0xe7,0x00,0x00,0xe7,0xe7,0xe7,
		0xff,0xff,0xc3,0x81,0x81,0x81,0xc3,0xff,
		0xff,0xff,0xff,0xff,0x00,0x00,0x00,0x00,
		0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,0xfc,
		0xff,0xff,0xff,0x00,0x00,0xe7,0xe7,0xe7,
		0xe7,0xe7,0xe7,0x00,0x00,0xff,0xff,0xff,
		0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,0xf0,
		0xe7,0xe7,0xe7,0x07,0x07,0xff,0xff,0xff,
		0xe1,0xf9,0xe1,0xf9,0x81,0xe7,0x87,0xff,
		0xff,0xe7,0xc3,0x81,0xe7,0xe7,0xe7,0xff,
		0xff,0xe7,0xe7,0xe7,0x81,0xc3,0xe7,0xff,
		0xff,0xe7,0xf3,0x81,0xf3,0xe7,0xff,0xff,
		0xff,0xe7,0xcf,0x81,0xcf,0xe7,0xff,0xff,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
		0xff,0xe7,0xe7,0xe7,0xe7,0xff,0xe7,0xff,
		0xff,0x99,0x99,0x99,0xff,0xff,0xff,0xff,
		0xff,0x99,0x00,0x99,0x99,0x00,0x99,0xff,
		0xe7,0x83,0xf9,0xc3,0x9f,0xc1,0xe7,0xff,
		0xff,0x99,0xc9,0xe7,0xf3,0x99,0x9d,0xff,
		0xc7,0x93,0xc7,0xe3,0x09,0x99,0x23,0xff,
		0xff,0xe7,0xe7,0xe7,0xff,0xff,0xff,0xff,
		0xff,0x8f,0xc7,0xe7,0xe7,0xc7,0x8f,0xff,
		0xff,0xf1,0xe3,0xe7,0xe7,0xe3,0xf1,0xff,
		0xff,0x99,0xc3,0x00,0xc3,0x99,0xff,0xff,
		0xff,0xe7,0xe7,0x81,0xe7,0xe7,0xff,0xff,
		0xff,0xff,0xff,0xff,0xff,0xe7,0xe7,0xf3,
		0xff,0xff,0xff,0x81,0xff,0xff,0xff,0xff,
		0xff,0xff,0xff,0xff,0xff,0xe7,0xe7,0xff,
		0xff,0x9f,0xcf,0xe7,0xf3,0xf9,0xfd,0xff,
		0xff,0xc3,0x99,0x89,0x91,0x99,0xc3,0xff,
		0xff,0xe7,0xe3,0xe7,0xe7,0xe7,0x81,0xff,
		0xff,0xc3,0x99,0xcf,0xe7,0xf3,0x81,0xff,
		0xff,0x81,0xcf,0xe7,0xcf,0x99,0xc3,0xff,
		0xff,0xcf,0xc7,0xc3,0xc9,0x81,0xcf,0xff,
		0xff,0x81,0xf9,0xc1,0x9f,0x99,0xc3,0xff,
		0xff,0xc3,0xf9,0xc1,0x99,0x99,0xc3,0xff,
		0xff,0x81,0x9f,0xcf,0xe7,0xf3,0xf3,0xff,
		0xff,0xc3,0x99,0xc3,0x99,0x99,0xc3,0xff,
		0xff,0xc3,0x99,0x83,0x9f,0xcf,0xe3,0xff,
		0xff,0xff,0xe7,0xe7,0xff,0xe7,0xe7,0xff,
		0xff,0xff,0xe7,0xe7,0xff,0xe7,0xe7,0xf3,
		0x9f,0xcf,0xe7,0xf3,0xe7,0xcf,0x9f,0xff,
		0xff,0xff,0x81,0xff,0xff,0x81,0xff,0xff,
		0xf9,0xf3,0xe7,0xcf,0xe7,0xf3,0xf9,0xff,
		0xff,0xc3,0x99,0xcf,0xe7,0xff,0xe7,0xff,
		0xff,0xc3,0x99,0x89,0x89,0xf9,0x83,0xff,
		0xff,0xe7,0xc3,0x99,0x99,0x81,0x99,0xff,
		0xff,0xc1,0x99,0xc1,0x99,0x99,0xc1,0xff,
		0xff,0xc3,0x99,0xf9,0xf9,0x99,0xc3,0xff,
		0xff,0xe1,0xc9,0x99,0x99,0xc9,0xe1,0xff,
		0xff,0x81,0xf9,0xc1,0xf9,0xf9,0x81,0xff,
		0xff,0x81,0xf9,0xc1,0xf9,0xf9,0xf9,0xff,
		0xff,0x83,0xf9,0xf9,0x89,0x99,0x83,0xff,
		0xff,0x99,0x99,0x81,0x99,0x99,0x99,0xff,
		0xff,0x81,0xe7,0xe7,0xe7,0xe7,0x81,0xff,
		0xff,0x9f,0x9f,0x9f,0x9f,0x99,0xc3,0xff,
		0xff,0x99,0xc9,0xe1,0xe1,0xc9,0x99,0xff,
		0xff,0xf9,0xf9,0xf9,0xf9,0xf9,0x81,0xff,
		0xff,0x39,0x11,0x01,0x29,0x39,0x39,0xff,
		0xff,0x99,0x91,0x81,0x81,0x89,0x99,0xff,
		0xff,0xc3,0x99,0x99,0x99,0x99,0xc3,0xff,
		0xff,0xc1,0x99,0x99,0xc1,0xf9,0xf9,0xff,
		0xff,0xc3,0x99,0x99,0x99,0xc9,0x93,0xff,
		0xff,0xc1,0x99,0x99,0xc1,0xc9,0x99,0xff,
		0xff,0xc3,0xf9,0xc3,0x9f,0x9f,0xc3,0xff,
		0xff,0x81,0xe7,0xe7,0xe7,0xe7,0xe7,0xff,
		0xff,0x99,0x99,0x99,0x99,0x99,0x81,0xff,
		0xff,0x99,0x99,0x99,0x99,0xc3,0xe7,0xff,
		0xff,0x39,0x39,0x29,0x01,0x11,0x39,0xff,
		0xff,0x99,0x99,0xc3,0xc3,0x99,0x99,0xff,
		0xff,0x99,0x99,0xc3,0xe7,0xe7,0xe7,0xff,
		0xff,0x81,0xcf,0xe7,0xf3,0xf9,0x81,0xff,
		0xff,0x87,0xe7,0xe7,0xe7,0xe7,0x87,0xff,
		0xff,0xfd,0xf9,0xf3,0xe7,0xcf,0x9f,0xff,
		0xff,0xe1,0xe7,0xe7,0xe7,0xe7,0xe1,0xff,
		0xff,0xef,0xc7,0x93,0x39,0xff,0xff,0xff,
		0xff,0xff,0xff,0xff,0xff,0xff,0x00,0xff,
		0xff,0xe7,0xc3,0x81,0x81,0xc3,0xe7,0xff,
		0xff,0xff,0xc3,0x9f,0x83,0x99,0x83,0xff,
		0xff,0xf9,0xf9,0xc1,0x99,0x99,0xc1,0xff,
		0xff,0xff,0xc3,0xf9,0xf9,0xf9,0xc3,0xff,
		0xff,0x9f,0x9f,0x83,0x99,0x99,0x83,0xff,
		0xff,0xff,0xc3,0x99,0x81,0xf9,0xc3,0xff,
		0xff,0x8f,0xe7,0x83,0xe7,0xe7,0xe7,0xff,
		0xff,0xff,0x83,0x99,0x99,0x83,0x9f,0xc1,
		0xff,0xf9,0xf9,0xc1,0x99,0x99,0x99,0xff,
		0xff,0xe7,0xff,0xe3,0xe7,0xe7,0xc3,0xff,
		0xff,0x9f,0xff,0x9f,0x9f,0x9f,0x9f,0xc3,
		0xff,0xf9,0xf9,0xc9,0xe1,0xc9,0x99,0xff,
		0xff,0xe3,0xe7,0xe7,0xe7,0xe7,0xc3,0xff,
		0xff,0xff,0x99,0x01,0x01,0x29,0x39,0xff,
		0xff,0xff,0xc1,0x99,0x99,0x99,0x99,0xff,
		0xff,0xff,0xc3,0x99,0x99,0x99,0xc3,0xff,
		0xff,0xff,0xc1,0x99,0x99,0xc1,0xf9,0xf9,
		0xff,0xff,0x83,0x99,0x99,0x83,0x9f,0x9f,
		0xff,0xff,0xc1,0x99,0xf9,0xf9,0xf9,0xff,
		0xff,0xff,0x83,0xf9,0xc3,0x9f,0xc1,0xff,
		0xff,0xe7,0x81,0xe7,0xe7,0xe7,0x8f,0xff,
		0xff,0xff,0x99,0x99,0x99,0x99,0x83,0xff,
		0xff,0xff,0x99,0x99,0x99,0xc3,0xe7,0xff,
		0xff,0xff,0x39,0x29,0x01,0x83,0x93,0xff,
		0xff,0xff,0x99,0xc3,0xe7,0xc3,0x99,0xff,
		0xff,0xff,0x99,0x99,0x99,0x83,0xcf,0xe1,
		0xff,0xff,0x81,0xcf,0xe7,0xf3,0x81,0xff,
		0xff,0xe7,0xc3,0x81,0x81,0xe7,0xc3,0xff,
		0xe7,0xe7,0xe7,0xe7,0xe7,0xe7,0xe7,0xe7,
		0xff,0x81,0xe1,0xc1,0x89,0x99,0x9f,0xff,
		0xef,0xe7,0xe3,0xe1,0xe3,0xe7,0xef,0xff,
		0xf7,0xe7,0xc7,0x87,0xc7,0xe7,0xf7,0xff,
		0x00,0x6c,0xfe,0xfe,0x7c,0x38,0x10,0x00,
		0x18,0x18,0x18,0xf8,0xf8,0x18,0x18,0x18,
		0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,
		0x18,0x18,0x18,0x1f,0x1f,0x00,0x00,0x00,
		0x18,0x18,0x18,0x1f,0x1f,0x18,0x18,0x18,
		0x00,0x00,0x00,0x1f,0x1f,0x18,0x18,0x18,
		0xc0,0xe0,0x70,0x38,0x1c,0x0e,0x07,0x03,
		0x03,0x07,0x0e,0x1c,0x38,0x70,0xe0,0xc0,
		0x80,0xc0,0xe0,0xf0,0xf8,0xfc,0xfe,0xff,
		0x00,0x00,0x00,0x00,0xf0,0xf0,0xf0,0xf0,
		0x01,0x03,0x07,0x0f,0x1f,0x3f,0x7f,0xff,
		0xf0,0xf0,0xf0,0xf0,0x00,0x00,0x00,0x00,
		0x0f,0x0f,0x0f,0x0f,0x00,0x00,0x00,0x00,
		0xff,0xff,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,
		0x00,0x00,0x00,0x00,0x0f,0x0f,0x0f,0x0f,
		0x00,0x38,0x38,0xee,0xee,0x10,0x38,0x00,
		0x00,0x00,0x00,0xf8,0xf8,0x18,0x18,0x18,
		0x00,0x00,0x00,0xff,0xff,0x00,0x00,0x00,
		0x18,0x18,0x18,0xff,0xff,0x18,0x18,0x18,
		0x00,0x00,0x3c,0x7e,0x7e,0x7e,0x3c,0x00,
		0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff,
		0x03,0x03,0x03,0x03,0x03,0x03,0x03,0x03,
		0x00,0x00,0x00,0xff,0xff,0x18,0x18,0x18,
		0x18,0x18,0x18,0xff,0xff,0x00,0x00,0x00,
		0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,0x0f,
		0x18,0x18,0x18,0xf8,0xf8,0x00,0x00,0x00,
		0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,
		0x00,0x18,0x3c,0x7e,0x18,0x18,0x18,0x00,
		0x00,0x18,0x18,0x18,0x7e,0x3c,0x18,0x00,
		0x00,0x18,0x0c,0x7e,0x0c,0x18,0x00,0x00,
		0x00,0x18,0x30,0x7e,0x30,0x18,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
		0x00,0x18,0x18,0x18,0x18,0x00,0x18,0x00,
		0x00,0x66,0x66,0x66,0x00,0x00,0x00,0x00,
		0x00,0x66,0xff,0x66,0x66,0xff,0x66,0x00,
		0x18,0x7c,0x06,0x3c,0x60,0x3e,0x18,0x00,
		0x00,0x66,0x36,0x18,0x0c,0x66,0x62,0x00,
		0x38,0x6c,0x38,0x1c,0xf6,0x66,0xdc,0x00,
		0x00,0x18,0x18,0x18,0x00,0x00,0x00,0x00,
		0x00,0x70,0x38,0x18,0x18,0x38,0x70,0x00,
		0x00,0x0e,0x1c,0x18,0x18,0x1c,0x0e,0x00,
		0x00,0x66,0x3c,0xff,0x3c,0x66,0x00,0x00,
		0x00,0x18,0x18,0x7e,0x18,0x18,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x0c,
		0x00,0x00,0x00,0x7e,0x00,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,
		0x00,0x60,0x30,0x18,0x0c,0x06,0x02,0x00,
		0x00,0x3c,0x66,0x76,0x6e,0x66,0x3c,0x00,
		0x00,0x18,0x1c,0x18,0x18,0x18,0x7e,0x00,
		0x00,0x3c,0x66,0x30,0x18,0x0c,0x7e,0x00,
		0x00,0x7e,0x30,0x18,0x30,0x66,0x3c,0x00,
		0x00,0x30,0x38,0x3c,0x36,0x7e,0x30,0x00,
		0x00,0x7e,0x06,0x3e,0x60,0x66,0x3c,0x00,
		0x00,0x3c,0x06,0x3e,0x66,0x66,0x3c,0x00,
		0x00,0x7e,0x60,0x30,0x18,0x0c,0x0c,0x00,
		0x00,0x3c,0x66,0x3c,0x66,0x66,0x3c,0x00,
		0x00,0x3c,0x66,0x7c,0x60,0x30,0x1c,0x00,
		0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x00,
		0x00,0x00,0x18,0x18,0x00,0x18,0x18,0x0c,
		0x60,0x30,0x18,0x0c,0x18,0x30,0x60,0x00,
		0x00,0x00,0x7e,0x00,0x00,0x7e,0x00,0x00,
		0x06,0x0c,0x18,0x30,0x18,0x0c,0x06,0x00,
		0x00,0x3c,0x66,0x30,0x18,0x00,0x18,0x00,
		0x00,0x3c,0x66,0x76,0x76,0x06,0x7c,0x00,
		0x00,0x18,0x3c,0x66,0x66,0x7e,0x66,0x00,
		0x00,0x3e,0x66,0x3e,0x66,0x66,0x3e,0x00,
		0x00,0x3c,0x66,0x06,0x06,0x66,0x3c,0x00,
		0x00,0x1e,0x36,0x66,0x66,0x36,0x1e,0x00,
		0x00,0x7e,0x06,0x3e,0x06,0x06,0x7e,0x00,
		0x00,0x7e,0x06,0x3e,0x06,0x06,0x06,0x00,
		0x00,0x7c,0x06,0x06,0x76,0x66,0x7c,0x00,
		0x00,0x66,0x66,0x7e,0x66,0x66,0x66,0x00,
		0x00,0x7e,0x18,0x18,0x18,0x18,0x7e,0x00,
		0x00,0x60,0x60,0x60,0x60,0x66,0x3c,0x00,
		0x00,0x66,0x36,0x1e,0x1e,0x36,0x66,0x00,
		0x00,0x06,0x06,0x06,0x06,0x06,0x7e,0x00,
		0x00,0xc6,0xee,0xfe,0xd6,0xc6,0xc6,0x00,
		0x00,0x66,0x6e,0x7e,0x7e,0x76,0x66,0x00,
		0x00,0x3c,0x66,0x66,0x66,0x66,0x3c,0x00,
		0x00,0x3e,0x66,0x66,0x3e,0x06,0x06,0x00,
		0x00,0x3c,0x66,0x66,0x66,0x36,0x6c,0x00,
		0x00,0x3e,0x66,0x66,0x3e,0x36,0x66,0x00,
		0x00,0x3c,0x06,0x3c,0x60,0x60,0x3c,0x00,
		0x00,0x7e,0x18,0x18,0x18,0x18,0x18,0x00,
		0x00,0x66,0x66,0x66,0x66,0x66,0x7e,0x00,
		0x00,0x66,0x66,0x66,0x66,0x3c,0x18,0x00,
		0x00,0xc6,0xc6,0xd6,0xfe,0xee,0xc6,0x00,
		0x00,0x66,0x66,0x3c,0x3c,0x66,0x66,0x00,
		0x00,0x66,0x66,0x3c,0x18,0x18,0x18,0x00,
		0x00,0x7e,0x30,0x18,0x0c,0x06,0x7e,0x00,
		0x00,0x78,0x18,0x18,0x18,0x18,0x78,0x00,
		0x00,0x02,0x06,0x0c,0x18,0x30,0x60,0x00,
		0x00,0x1e,0x18,0x18,0x18,0x18,0x1e,0x00,
		0x00,0x10,0x38,0x6c,0xc6,0x00,0x00,0x00,
		0x00,0x00,0x00,0x00,0x00,0x00,0xff,0x00,
		0x00,0x18,0x3c,0x7e,0x7e,0x3c,0x18,0x00,
		0x00,0x00,0x3c,0x60,0x7c,0x66,0x7c,0x00,
		0x00,0x06,0x06,0x3e,0x66,0x66,0x3e,0x00,
		0x00,0x00,0x3c,0x06,0x06,0x06,0x3c,0x00,
		0x00,0x60,0x60,0x7c,0x66,0x66,0x7c,0x00,
		0x00,0x00,0x3c,0x66,0x7e,0x06,0x3c,0x00,
		0x00,0x70,0x18,0x7c,0x18,0x18,0x18,0x00,
		0x00,0x00,0x7c,0x66,0x66,0x7c,0x60,0x3e,
		0x00,0x06,0x06,0x3e,0x66,0x66,0x66,0x00,
		0x00,0x18,0x00,0x1c,0x18,0x18,0x3c,0x00,
		0x00,0x60,0x00,0x60,0x60,0x60,0x60,0x3c,
		0x00,0x06,0x06,0x36,0x1e,0x36,0x66,0x00,
		0x00,0x1c,0x18,0x18,0x18,0x18,0x3c,0x00,
		0x00,0x00,0x66,0xfe,0xfe,0xd6,0xc6,0x00,
		0x00,0x00,0x3e,0x66,0x66,0x66,0x66,0x00,
		0x00,0x00,0x3c,0x66,0x66,0x66,0x3c,0x00,
		0x00,0x00,0x3e,0x66,0x66,0x3e,0x06,0x06,
		0x00,0x00,0x7c,0x66,0x66,0x7c,0x60,0x60,
		0x00,0x00,0x3e,0x66,0x06,0x06,0x06,0x00,
		0x00,0x00,0x7c,0x06,0x3c,0x60,0x3e,0x00,
		0x00,0x18,0x7e,0x18,0x18,0x18,0x70,0x00,
		0x00,0x00,0x66,0x66,0x66,0x66,0x7c,0x00,
		0x00,0x00,0x66,0x66,0x66,0x3c,0x18,0x00,
		0x00,0x00,0xc6,0xd6,0xfe,0x7c,0x6c,0x00,
		0x00,0x00,0x66,0x3c,0x18,0x3c,0x66,0x00,
		0x00,0x00,0x66,0x66,0x66,0x7c,0x30,0x1e,
		0x00,0x00,0x7e,0x30,0x18,0x0c,0x7e,0x00,
		0x00,0x18,0x3c,0x7e,0x7e,0x18,0x3c,0x00,
		0x18,0x18,0x18,0x18,0x18,0x18,0x18,0x18,
		0x00,0x7e,0x1e,0x3e,0x76,0x66,0x60,0x00,
		0x10,0x18,0x1c,0x1e,0x1c,0x18,0x10,0x00,
		0x08,0x18,0x38,0x78,0x38,0x18,0x08,0x00,
	};

	static bool __clip(

		//these are legacy, but here in case you would want to clip to some other rect than the whole bitmap
		const int32_t in_cliprect_x,
		const int32_t in_cliprect_y,
		const int32_t in_cliprect_z,
		const int32_t in_cliprect_w,
		//these are legacy, but here in case you would want to clip to some other rect than the whole bitmap

		int32_t& out_src_x, int32_t& out_src_y, int32_t& out_dst_x, int32_t& out_dst_y, int32_t& out_width, int32_t& out_height)
	{
		//REJECTION TEST
		if ((out_dst_x + out_width) < in_cliprect_x ||
			out_dst_x >= in_cliprect_z ||
			(out_dst_y + out_height) < in_cliprect_y ||
			out_dst_y >= in_cliprect_w)
		{
			return false;
		}

		int32_t clip;

		//CLIP
		//x
		if (out_dst_x < in_cliprect_x)
		{
			clip = out_dst_x - in_cliprect_x;
			out_src_x -= clip;
			out_width += clip;
			out_dst_x = in_cliprect_x;
		}

		//return if no width
		if (out_width <= 0)
			return false;

		//z
		if ((out_dst_x + out_width) >= in_cliprect_z)
			out_width = in_cliprect_z - out_dst_x;

		//return if no width
		if (out_width <= 0)
			return false;

		//y
		if (out_dst_y < in_cliprect_y)
		{
			clip = out_dst_y - in_cliprect_y;
			out_src_y -= clip;
			out_height += clip;
			out_dst_y = in_cliprect_y;
		}

		//return if no height
		if (out_height <= 0)
			return false;

		//w
		if ((out_dst_y + out_height) >= in_cliprect_w)
			out_height = in_cliprect_w - out_dst_y;

		return out_height > 0;
	}

	//public
	//public
	//public
	//public

	void vc_canvas_clear_set(
		const uint8_t& in_color, const int32_t in_dst_x, const int32_t in_dst_y, const int32_t in_clear_width, const int32_t in_clear_height,
		micron_t& out_micron)
	{
		uint8_t* dst = out_micron.canvas + in_dst_x + in_dst_y * out_micron.canvas_width;
		uint8_t* scan_dst;
		for (
			int32_t y = 0;
			y < in_clear_height;
			++y
			)
		{
			scan_dst = dst;

			for (
				int32_t x = 0;
				x < in_clear_width;
				++x
				)
			{
				assert(
					dst >= out_micron.canvas &&
					dst < out_micron.canvas + out_micron.canvas_width * out_micron.canvas_height
				);
				*dst++ = in_color;
			}

			dst = scan_dst + out_micron.canvas_width;
		}
	}

	void vc_canvas_clear_stipple(
		const uint8_t& in_color, int32_t in_dst_x, int32_t in_dst_y, int32_t in_clear_width, int32_t in_clear_height,
		micron_t& out_micron)
	{
		//clip
		int32_t src_x = 0;
		int32_t src_y = 0;
		if (__clip(

			//these are legacy, but here in case you would want to clip to some other rect than the whole bitmap
			0, 0, out_micron.canvas_width, out_micron.canvas_height,
			//these are legacy, but here in case you would want to clip to some other rect than the whole bitmap

			src_x, src_y, in_dst_x, in_dst_y, in_clear_width, in_clear_height))
		{
			uint8_t* dst = out_micron.canvas + in_dst_x + in_dst_y * out_micron.canvas_width;
			uint8_t* scan_dst;
			for (
				int32_t y = 0;
				y < in_clear_height;
				++y
				)
			{
				scan_dst = dst;
				dst += y % 2;

				for (
					int32_t x = 0;
					x < in_clear_width;
					x += 2
					)
				{
					assert(
						dst >= out_micron.canvas &&
						dst < out_micron.canvas + out_micron.canvas_width * out_micron.canvas_height
					);
					*dst = in_color;
					dst += 2;
				}

				dst = scan_dst + out_micron.canvas_width;
			}
		}
	}

	void vc_canvas_set_pixel(
		const int32_t in_x, const int32_t in_y, const uint8_t& in_color,
		micron_t& out_micron)
	{
		uint8_t* dst = out_micron.canvas + in_x + in_y * out_micron.canvas_width;
		assert(
			dst >= out_micron.canvas &&
			dst < out_micron.canvas + out_micron.canvas_width * out_micron.canvas_height
		);
		*dst = in_color;
	}

	void vc_canvas_h_line(
		int32_t in_x1, int32_t in_x2, const int32_t in_y1, const uint8_t& in_color,
		micron_t& out_micron)
	{
		//clip
		if (in_y1 < 0 || in_y1 >= out_micron.canvas_height)
			return;

		c_int32_min_max(in_x1, in_x2);
		in_x1 = __max(0, in_x1);
		in_x2 = __min(out_micron.canvas_width, in_x2);
		uint8_t* dst = out_micron.canvas + in_x1 + in_y1 * out_micron.canvas_width;

		for (
			int32_t x = in_x1;
			x < in_x2;
			++x
			)
		{
			assert(
				dst >= out_micron.canvas &&
				dst < out_micron.canvas + out_micron.canvas_width * out_micron.canvas_height
			);
			*dst++ = in_color;
		}
	}

	void vc_canvas_v_line(
		const int32_t in_x1, int32_t in_y1, int32_t in_y2, const uint8_t& in_color,
		micron_t& out_micron)
	{
		//clip
		if (in_x1 < 0 || in_x1 >= out_micron.canvas_width)
			return;

		c_int32_min_max(in_y1, in_y2);
		in_y1 = __max(0, in_y1);
		in_y2 = __min(out_micron.canvas_height, in_y2);
		uint8_t* dst = out_micron.canvas + in_x1 + in_y1 * out_micron.canvas_width;

		for (
			int32_t y = in_y1;
			y < in_y2;
			++y
			)
		{
			assert(
				dst >= out_micron.canvas &&
				dst < out_micron.canvas + out_micron.canvas_width * out_micron.canvas_height
			);
			*dst = in_color;
			dst += out_micron.canvas_width;
		}
	}

	void vc_canvas_rect(
		const int32_t in_x1, const int32_t in_y1, const int32_t in_x2, const int32_t in_y2, const uint8_t& in_color,
		micron_t& out_micron)
	{
		vc_canvas_h_line(in_x1, in_x2 + 1, in_y1, in_color, out_micron);
		vc_canvas_h_line(in_x1, in_x2 + 1, in_y2, in_color, out_micron);
		vc_canvas_v_line(in_x1, in_y1 + 1, in_y2, in_color, out_micron);
		vc_canvas_v_line(in_x2, in_y1 + 1, in_y2, in_color, out_micron);
	}

	void vc_canvas_atascii_print(
		const int32_t in_x, const int32_t in_y, const uint8_t in_color, const void* in_string,
		micron_t& out_micron)
	{
		int32_t x = in_x;
		int32_t signed_offset;
		const uint8_t* c = (uint8_t*)in_string;
		while (*c)
		{
			for (int32_t bit_y = 0; bit_y < 8; ++bit_y)
			{
				for (int32_t bit_x = 0; bit_x < 8; ++bit_x)
				{
					signed_offset = x + bit_x + (in_y + bit_y) * out_micron.canvas_width;
					assert(signed_offset >= 0 && signed_offset < out_micron.canvas_width * out_micron.canvas_height);
					if (ATASCII_BITS[*c * 8 + bit_y] & (1 << bit_x))
						out_micron.canvas[signed_offset] = 15;
					else
						out_micron.canvas[signed_offset] = in_color;
				}
			}
			x += 8;
			if (x >= out_micron.canvas_width)
				return;
			++c;
		}
	}

	vc_fatpack_t::vc_fatpack_t()
	{
		tile_anim_tick = 0.f;

		bit_display_visited = 0;
		bit_display_hero_tests = 0;
		bit_camera_lerp = 0;
		bit_display_cambits = 0;
		bit_play_music = 1;

		idle_screen = VC_SCREEN_MAIN;

		last_visit_offset = UINT32_MAX;

		hero_anim = 0.f;

		//assert(0 == fx.used);
		assert(0 == gui_num_text);

		prng = c_xorshift128_t::make(0);
	}

	/*
	vc_fatpack_t::~vc_fatpack_t()
	{
		delete[] canvas.pixels;
	}
	*/

	vc_fx_t* vc_fatpack_t::fx_acquire()
	{
		fx.resize(fx.size() + 1);
		return fx.data() + fx.size() - 1;
	}
}
